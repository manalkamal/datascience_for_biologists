---
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: [default, chocolate, chocolate-fonts]
    nature:
      highlightStyle:  rainbow
      highlightLines: true
      countIncrementalSlides: false
    seal: false
---

```{css, include=FALSE, echo=FALSE}
.title-slide .bg-text{
  position: absolute;
  top: 45%;
  left: 10%;
  text-align: left;
  color: #000;
}

.huge .remark-code { /*Change made here*/
  font-size: 200% !important;
}
.teenytiny .remark-inline-code { /*Change made here*/
  font-size: 10% !important;
}


```


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(fig.width=6, fig.height=4)
library(xaringan)
library(tidyverse) 
library(cowplot)
library(patchwork)
library(colorblindr)
theme_set(theme_cowplot())
img_path <- "img/dplyr/"
plant <- as_tibble(CO2) %>%
  rename(plant_id = Plant,
         origin = Type,
         treatment = Treatment,
         co2_conc = conc,
         co2_rate = uptake) %>%
  mutate(plant_id = factor(plant_id))
```

class: title-slide

<!--background-image: url(slide_background_images/) --> 

.bg-text[
# Introduction to `dplyr`
## Data Science for Biologists

<hr />
**Image by TBD**
]


---
--- 


.pull-left[
```{r out.width = '250px', echo=F}
knitr::include_graphics(file.path(img_path, "dplyr_hex_old.jpg"))
```
]
.pull-right[
```{r out.width = '250px', echo=F}
knitr::include_graphics(file.path(img_path, "dplyr_hex_new.png"))
```
]

---
class: top, center

# The great and powerful **pipe**

```{r out.width = '375px', echo=F}
knitr::include_graphics(file.path(img_path, "MagrittePipe.jpg"))
```

--

```{r out.width = '200px', echo=F}
knitr::include_graphics(file.path(img_path, "pipe.png"))
```

---

# Examples of piping, and formatting goals

```{r}
## Tired
log(5)
```
<br><br>
--

```{r}
## Wired
5 %>% log()
```
<br><br>

--

```{r}
## Inspired
5 %>%
  log()
```

---

# Cold tolerance experiment on grass species

```{r}
head(plant)
nrow(plant)
ncol(plant)
```

---
# Loading libraries

```{r}
## LOAD THE DPLYR LIBRARY
library(dplyr)
```

## You must load the library for each R session OR NONE OF THIS WORKS!!

---

```{r, echo=F}
print.data.frame(plant %>% slice(1:40), row.names=F)
```

---

```{r, echo=F}
print.data.frame(plant %>% slice(50:82), row.names=F)
```


---

# Look at the data:

```{r}
## your first dplyr function!
glimpse(plant)
```

--

```{r}
levels(plant$plant_id)
```
```{r}
levels(plant$origin)
```
```{r}
levels(plant$treatment)
```

---

# Common tasks we perform on datasets 

+ Subsetting rows. 
    + Ex: Work with only Mississippi plants.
    + Ex: Work with only plants under certain experimental conditions.
+ Removing duplicate rows
<br><br>
+ Creating new columns
+ Rearranging, removing, or keeping only certain column
+ Renaming columns
<br><br>
+ Arrange the data based on a column
    + Ex: Arrange in order of CO2 uptake rate
<br><br>
+ Summarizing data
    + Ex: Calculating the mean of a variable
    + Ex: Calculating the mean for *each group* of a variable
---

# Functions ("verbs") for wrangling datasets

+ Subsetting rows. **`filter()`**
    + Ex: Work with only Mississippi plants.
    + Ex: Work with only plants under certain experimental conditions.
+ Removing duplicate rows **`distinct()`**
<br><br>
+ Creating new columns **`mutate()`**
+ Rearranging, removing, or keeping only certain column **`select()`**
+ Renaming columns **`rename()`**
<br><br>
+ Arrange the data based on a column **`arrange()`**
    + Ex: Arrange in order of CO2 uptake rate
<br><br>
+ Summarizing data **`summarize()`**
    + Ex: Calculating the mean of a variable
    + Ex: Calculating the mean for *each group* of a variable
--

### Data frame in, data frame out.

The *first argument* for all functions is a data frame (tibble).
All functions *return* a data frame (tibble). 

---

# Diving in with `filter()`


```{r}
# Reminder of the dataset:
head(plant)
levels(plant$origin)
```

--

+ All common `dplyr` verbs follow this paradigm:
  + First argument: a data frame
  + Additional argument(s): **logical statements** (code that gives `TRUE` OR `FALSE`) about which rows you want to keep
  + *We can directly refer to columns within `dplyr` code*


---

# Diving in with `filter()`

+ First argument: a data frame
+ Additional argument(s): **logical statements** (code that gives `TRUE` OR `FALSE`) about which rows you want to keep
+ *We can directly refer to columns within `dplyr` code*


```{r}
# Keep only Mississippi plants:
filter(plant, origin == "Mississippi")
```

---

# Using pipe is the preferred style

```{r}
# Not preferred:
# filter(plant, origin == "Mississippi")

# Also not preferred:
# plant %>% filter(origin == "Mississippi")

# THIS!!!!
plant %>%
  filter(origin == "Mississippi")
```
---

# Cautionary tales

```{r}
tail(plant)
```

--

```{r, error=TRUE}
plant %>%
  filter(origin == "Misissippi")
```

---


# Cautionary tales

```{r}
tail(plant)
```


```{r, error=TRUE}
plant %>%
  filter(origin == "mississippi")
```

---

# Cautionary tales

```{r}
tail(plant)
```


```{r, error=TRUE}
plant %>%
  filter(orgin == "Mississippi")
```

---


# Cautionary tales

```{r}
tail(plant)
```


```{r, error=TRUE}
plant %>%
  filter(ORIGIN == "Mississippi")
```

---

# Cautionary tales

```{r}
tail(plant)
```


```{r, error=TRUE}
plant 
  %>% filter(origin == "Mississippi")
```

---

# We can have multiple conditions in `filter()`

+ Using a comma in filter acts as "and" (`&`). 
+ Keep all rows where ALL conditions are `TRUE`

```{r}
plant %>%
  filter(origin == "Mississippi", treatment == "chilled")
```

---

# We can have multiple conditions in `filter()`


```{r}
plant %>%
  filter(origin == "Mississippi", treatment == "chilled", co2_conc >= 500)
```

---


# Separate onto new lines when code gets too long

```{r}
plant %>%
  filter(origin == "Mississippi", 
         treatment == "chilled", 
         co2_conc >= 500)
```

**Caution!!** Make sure the commas are always on at the _end of a line_

---

# Goal: Subset to plants with concentrations either 95 or 500

```{r}
unique(plant$co2_conc)
```

--

```{r}
plant %>%
  filter(co2_conc == 95, 
         co2_conc == 500)
```

--

**That code DID WORK.** It retained all rows whose `co2_conc` equaled 95 AND 500! ....But there are no such rows!!


**To reinterate: The code worked perfectly fine, but it didn't do what you might have expected. This is a type of a bug.**


---

## Recall the `%in%` operator

```{r}
colors <- c("red", "orange", "yellow")
"red" %in% colors
"blue" %in% colors
```

---

# Get rows with _either_ concentration using `%in%`

```{r}
plant %>%
  filter(co2_conc %in% c(95, 500))
```

--

```{r, eval=FALSE}
conc_values <- c(95, 500)
plant %>%
  filter(co2_conc %in% conc_values)
```

---

# Have as many options as you want:

```{r}
plant %>%
  filter(plant_id %in% c("Qn1", "Qc1", "Mn1", "Mc1"))
```

---

# One reason filtering is important:

```{r}
ggplot(plant, aes(x = treatment, 
                  y = co2_rate,
                  fill = treatment)) + 
  geom_boxplot()
```

--

But what if I *only* want to plot Mississippi plants?

---

# Plotting filtered data 

```{r}
plant %>%
  filter(origin == "Mississippi") -> plant_miss

ggplot(plant_miss, aes(x = treatment, 
                  y = co2_rate,
                  fill = treatment)) + 
  geom_boxplot()
```

---

# Plotting filtered data 

```{r}
plant %>%
  filter(origin == "Mississippi") %>%
  ggplot(aes(x = treatment, 
             y = co2_rate,
             fill = treatment)) + 
    geom_boxplot()
```

**Caution:** Be careful to use `%>%` and `+` in the right place. Using the wrong one in the wrong place is a common mistake!

---


# Removing, keeping, rearranging columns with `select()`

.pull-left[
```{r}
plant %>%
  select(plant_id, treatment)
```
]
--
.pull-right[
```{r}
plant %>%
  select(-plant_id, -treatment)
```
]
---

# There is a lot of magic in `select()`

```{r}
head(plant, 2)

plant %>%
  select(co2_rate, everything())
```

---


# Creating new columns with `mutate()`

```{r}
plant %>%
  mutate(the_number_5 = 5)
```

---


# Creating new columns with `mutate()`

Again, we can directly reference existing columns: 

```{r}
plant %>%
  mutate(co2_rate_x100 = co2_rate * 100)
```

**New column names should always begin with a LETTER and only contain letters, numbers, and underscores.**

---
